"use strict";(()=>{var e={};e.id=291,e.ids=[291],e.modules={20399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},30517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},27790:e=>{e.exports=require("assert")},78893:e=>{e.exports=require("buffer")},84770:e=>{e.exports=require("crypto")},80665:e=>{e.exports=require("dns")},17702:e=>{e.exports=require("events")},92048:e=>{e.exports=require("fs")},98216:e=>{e.exports=require("net")},19801:e=>{e.exports=require("os")},55315:e=>{e.exports=require("path")},76162:e=>{e.exports=require("stream")},74026:e=>{e.exports=require("string_decoder")},82452:e=>{e.exports=require("tls")},74175:e=>{e.exports=require("tty")},17360:e=>{e.exports=require("url")},21764:e=>{e.exports=require("util")},6005:e=>{e.exports=require("node:crypto")},21762:(e,t,r)=>{r.r(t),r.d(t,{originalPathname:()=>P,patchFetch:()=>I,requestAsyncStorage:()=>A,routeModule:()=>b,serverHooks:()=>w,staticGenerationAsyncStorage:()=>S});var o={};r.r(o),r.d(o,{GET:()=>g});var a=r(42812),s=r(540),i=r(59173),n=r(79681),l=r(67640),p=r.n(l),u=r(79679),d=r(6005),c=r.n(d),_=r(14472),m=r(28811);function h(e,t){return[e*Math.PI/180*6378137,6378137*Math.log(Math.tan(Math.PI/4+Math.max(Math.min(t,89.999999),-89.999999)*Math.PI/360))]}let y=_.Ry({bbox:_.Z_().refine(e=>4===e.split(",").length,{message:"bbox must be minLon,minLat,maxLon,maxLat"}),types:_.Z_().optional(),limit:_.Z_().optional().transform(e=>e?Math.min(500,Math.max(1,parseInt(e,10))):300),debug:_.Z_().optional()});function f(e,t){let r=new Map(Object.entries(e).map(([e,t])=>[e.toLowerCase(),t]));for(let e of t){let t=r.get(e.toLowerCase());if(null!=t&&String(t).length>0)return t}}let x=(0,r(20658).h)("api/food/snap");function R(){let e=process.env.REDIS_URL;if(!e)return null;let t=global;return t.__cl_redis||(t.__cl_redis=new(p())(e,{maxRetriesPerRequest:2})),t.__cl_redis}async function Z(e,t,r=4){let o=200;for(let a=0;a<=r;a+=1){let s=new AbortController,i=setTimeout(()=>s.abort(),t.timeoutMs);try{let t=await fetch(e,{signal:s.signal,headers:{accept:"application/json"},cache:"no-store"});if(clearTimeout(i),!t.ok)throw Error(`HTTP ${t.status}`);let r=await t.json();if(r&&r.error)throw Error("ArcGIS error body");return r}catch(e){if(clearTimeout(i),a===r)throw e;await new Promise(e=>setTimeout(e,o)),o=Math.min(2e3,2*o)}}}async function g(e){let t;let r=new URL(e.url),o=y.safeParse(Object.fromEntries(r.searchParams.entries()));if(!o.success)return n.NextResponse.json({error:{code:"BAD_REQUEST",message:o.error.message}},{status:400});let{bbox:a,types:s,limit:i,debug:l}=o.data,p=function(e){let t=(0,m.w_)(e);return(0,m.ci)(t)}(a),d=!l,_=d?`snap:${function(e){let t=Object.keys(e).sort().map(t=>`${t}=${e[t]??""}`).join("|");return c().createHash("sha256").update(t).digest("hex")}({bbox:p.join(","),types:s,limit:i})}`:null;if(x.info("request",{bbox:p.join(","),types:s,limit:i,debug:l}),d&&_)try{let e=R();if(e){let t=await e.get(_);if(t){let e=JSON.parse(t);return x.debug("cache hit",{key:_}),n.NextResponse.json(e,{headers:{"x-cache":"hit"}})}}}catch(e){x.warn("cache get error",{key:_,error:e instanceof Error?e.message:String(e)})}try{t=function(e,t,r){let o=process.env.USDA_SNAP_ARCGIS_FEATURE_URL||process.env.USDA_SNAP_ARCGIS_URL||"https://services2.arcgis.com/VhQ18K5S5F7fNwJ0/ArcGIS/rest/services/USDA_SNAP_Retailers/FeatureServer/0/query",[a,s,i,n]=e,[l,p]=h(a,s),[u,d]=h(i,n),c=new URL(o);return c.searchParams.set("f","json"),c.searchParams.set("where","1=1"),c.searchParams.set("inSR","102100"),c.searchParams.set("outSR","4326"),c.searchParams.set("spatialRel","esriSpatialRelIntersects"),c.searchParams.set("returnGeometry","true"),c.searchParams.set("geometryType","esriGeometryEnvelope"),c.searchParams.set("geometry",`${l},${p},${u},${d}`),c.searchParams.set("outFields","Store_Name,Store_Street_Address,Additonal_Address,City,State,Zip_Code,Zip4,County,Store_Type,Latitude,Longitude,Incentive_Program,Grantee_Name"),c.searchParams.set("resultOffset","0"),c.searchParams.set("resultRecordCount",String(t)),c.searchParams.set("geometryPrecision","5"),c.toString()}(p,i);let e=Number(process.env.USDA_SNAP_TIMEOUT_MS),r=Number.isFinite(e)&&e>0?e:45e3,o=await Z(t,{timeoutMs:r},4),a=function(e){if(!e||"object"!=typeof e)return[];if(e.error)throw Error("ArcGIS error body");let t=Array.isArray(e.features)?e.features:[],r=[];for(let e of t){let t=e&&"object"==typeof e&&e.attributes||{},o=e&&"object"==typeof e&&e.geometry||{},a=f(t,["store_name","storename","name"]),s=f(t,["store_street_address","street_address","address","addr","site_address"]),i=f(t,["additonal_address","additional_address"]),n=f(t,["city","municipality"]),l=f(t,["state","st"]),p=f(t,["zip","zip_code","zipcode","postalcode"]),u=f(t,["zip4","zip_4","zipcode_4"]),d=f(t,["store_type","type","category"]),_=f(t,["phone","phone_number","phonenumber","phone number"]),m=f(t,["hours","store_hours","opening_hours","open_hours","operation_hours"]),h=o?.x??f(t,["longitude","lon","x"]),y=o?.y??f(t,["latitude","lat","y"]);if(!a||!s||"number"!=typeof h||"number"!=typeof y)continue;let x=[s,i,n,l,u&&p?`${p}-${u}`:p].filter(Boolean).join(", ");r.push({id:c().createHash("sha1").update(`${a}|${x}|${h},${y}`).digest("hex"),name:String(a),address:String(x),coords:[Number(h),Number(y)],storeType:d?String(d):void 0,phone:_?String(_):null,hours:m?String(m):null})}return r}(o),m=a;if(s){let e=new Set(s.split(",").map(e=>e.trim().toLowerCase()).filter(Boolean));m=a.filter(t=>!!t.storeType&&e.has(t.storeType.toLowerCase()))}let y=m.slice(0,i),g={items:y.map(e=>u.eD.parse(e)),source:"USDA ArcGIS",lastUpdated:new Date().toISOString()};if("raw"===l)return n.NextResponse.json({upstream:o,response:g,arcgisUrl:t});if("url"===l)return n.NextResponse.json({arcgisUrl:t});if(d&&_)try{let e=R();if(e){let t=600+Math.floor(1200*Math.random());await e.set(_,JSON.stringify(g),"EX",t),x.debug("cache set",{key:_,ttl:t})}}catch(e){x.warn("cache set error",{key:_,error:e instanceof Error?e.message:String(e)})}return x.info("success",{count:y.length}),n.NextResponse.json(g,{headers:{"x-cache":"miss"}})}catch(o){let e=o instanceof Error?o.message:String(o);x.error("upstream error",{error:e,arcgisUrl:t});let r={error:{code:"UPSTREAM_UNAVAILABLE",upstream:"USDA"}};return l&&(r.error.message=e,t&&(r.error.arcgisUrl=t)),n.NextResponse.json(r,{status:503})}}let b=new a.AppRouteRouteModule({definition:{kind:s.x.APP_ROUTE,page:"/api/food/snap/route",pathname:"/api/food/snap",filename:"route",bundlePath:"app/api/food/snap/route"},resolvedPagePath:"/Users/ejuchheim/Projects/Civic-Lifeline/CLwebsite/apps/web/app/api/food/snap/route.ts",nextConfigOutput:"",userland:o}),{requestAsyncStorage:A,staticGenerationAsyncStorage:S,serverHooks:w}=b,P="/api/food/snap/route";function I(){return(0,i.patchFetch)({serverHooks:w,staticGenerationAsyncStorage:S})}},20658:(e,t,r)=>{r.d(t,{h:()=>o});function o(e){let t=(t,r,o)=>{console.log(JSON.stringify({timestamp:function(){try{return new Date().toISOString()}catch{return""}}(),level:t,message:r,namespace:e,context:o}))};return{debug:(e,r)=>t("debug",e,r),info:(e,r)=>t("info",e,r),warn:(e,r)=>t("warn",e,r),error:(e,r)=>t("error",e,r)}}},79679:(e,t,r)=>{r.d(t,{Ni:()=>a,oj:()=>_,eD:()=>f,yt:()=>y,eC:()=>i});var o=r(14472);let a=o.Z_().regex(/^\d{5}$/),s=o.Z_().regex(/^\d{4}-\d{2}-\d{2}T\d{2}:\d{2}:\d{2}(\.\d+)?Z$/),i=o.Rx().int().gte(1990).lte(2100),n=o.Rx().gte(-180).lte(180),l=o.Rx().gte(-90).lte(90),p=o.Ry({type:o.i0("Point"),coordinates:o.bc([n,l])});o.Ry({_id:o.Z_(),name:o.Z_(),address:o.Z_(),city:o.Z_().optional(),state:o.Z_().optional(),postalCode:o.Z_().optional(),storeType:o.Z_().optional(),phone:o.Z_().nullable().optional(),hours:o.Z_().nullable().optional(),loc:p,source:o.i0("USDA ArcGIS"),sourceUrl:o.Z_(),fetchedAt:s,dataVintage:o.Z_().optional(),createdAt:s,updatedAt:s});let u=o.Ry({date:o.Z_().regex(/^\d{4}-\d{2}$/),value:o.Rx()});o.Ry({_id:o.Z_(),countyFips:a,adjusted:o.O7(),unit:o.i0("percent"),points:o.IX(u),source:o.i0("BLS LAUS"),sourceUrl:o.Z_().optional(),fetchedAt:s,createdAt:s,updatedAt:s});let d=o.Ry({"25_3":o.O7(),"100_20":o.O7(),"1000_100":o.O7()});o.Ry({_id:o.Z_(),geoType:o.G0([o.i0("county"),o.i0("tract")]),fips:o.Z_(),asOf:o.Z_().regex(/^\d{4}-\d{2}-\d{2}$/),providerCount:o.Rx().int().nonnegative(),speed:d,tech:o.IX(o.Z_()),source:o.i0("FCC NBM CSV"),sourceUrl:o.Z_(),fetchedAt:s,createdAt:s,updatedAt:s});let c=o.Ry({id:o.Z_(),name:o.Z_(),phone:o.Z_().nullable().optional(),website:o.Z_().nullable().optional(),services:o.IX(o.Z_()).optional(),languages:o.IX(o.Z_()).optional(),loc:p.optional()});o.Ry({_id:o.Z_(),lat:o.Rx(),lon:o.Rx(),radius:o.Rx(),items:o.IX(c),source:o.i0("HUD Housing Counselor API"),sourceUrl:o.Z_(),fetchedAt:s,createdAt:s,updatedAt:s}),o.Ry({_id:o.Z_(),fips:a,year:o.Rx().int(),areaName:o.Z_(),br0:o.Rx(),br1:o.Rx(),br2:o.Rx(),br3:o.Rx(),br4:o.Rx(),source:o.i0("HUD FMR API"),sourceUrl:o.Z_(),fetchedAt:s,createdAt:s,updatedAt:s});let _=o.G0([o.i0("wifi"),o.i0("food_pantry"),o.i0("meal_site"),o.i0("clinic"),o.i0("other")]);o.Ry({_id:o.Z_(),type:_,name:o.Z_(),description:o.Z_().optional(),loc:p,address:o.Z_().optional(),contact:o.Ry({phone:o.Z_().optional(),email:o.Z_().optional(),site:o.Z_().optional()}).optional(),hours:o.Z_().optional(),submittedBy:o.Z_().nullable().optional(),verified:o.Ry({by:o.Z_(),at:s,method:o.G0([o.i0("phone"),o.i0("site"),o.i0("email")])}).optional(),createdAt:s,updatedAt:s});let m=o.G0([o.i0("user"),o.i0("moderator"),o.i0("admin")]);o.Ry({_id:o.Z_(),email:o.Z_().email(),passwordHash:o.Z_().optional(),role:m,profile:o.Ry({name:o.Z_().optional(),zip:o.Z_().optional()}).optional(),createdAt:s,updatedAt:s});let h=o.G0([o.i0("repair_request"),o.i0("benefits_inquiry"),o.i0("other")]);o.Ry({_id:o.Z_(),userId:o.Z_(),type:h,inputs:o.IM(o._4()),text:o.Z_().optional(),pdfKey:o.Z_(),createdAt:s,updatedAt:s});let y=o.Ry({source:o.Z_(),lastUpdated:s,dataVintage:o.Z_().optional()}),f=o.Ry({id:o.Z_(),name:o.Z_(),address:o.Z_(),coords:o.bc([o.Rx(),o.Rx()]),storeType:o.Z_().optional(),phone:o.Z_().nullable().optional(),hours:o.Z_().nullable().optional()});o.Ry({items:o.IX(f)}).and(y),o.Ry({seriesId:o.Z_(),adjusted:o.O7(),points:o.IX(o.Ry({date:o.Z_(),value:o.Rx()}))}).and(y),o.Ry({providerCount:o.Rx().int(),speed:o.Ry({"25_3":o.O7(),"100_20":o.O7(),"1000_100":o.O7()}),tech:o.IX(o.Z_()),asOf:o.Z_()}).and(y);let x=o.Ry({id:o.Z_(),name:o.Z_(),phone:o.Z_().optional(),website:o.Z_().optional(),services:o.IX(o.Z_()).optional(),languages:o.IX(o.Z_()).optional(),coords:o.bc([o.Rx(),o.Rx()]).optional()});o.Ry({items:o.IX(x)}).and(y),o.Ry({year:o.Rx().int(),areaName:o.Z_(),br0:o.Rx(),br1:o.Rx(),br2:o.Rx(),br3:o.Rx(),br4:o.Rx()}).and(y),o.Ry({error:o.Ry({code:o.Z_(),message:o.Z_(),upstream:o.Z_().optional()})})},28811:(e,t,r)=>{function o(e){if(Array.isArray(e)){if(4!==e.length)throw Error("bbox array must have 4 numbers");return[Number(e[0]),Number(e[1]),Number(e[2]),Number(e[3])]}let t=e.split(",").map(e=>Number(e.trim()));if(4!==t.length||t.some(e=>Number.isNaN(e)))throw Error("invalid bbox string");return[t[0],t[1],t[2],t[3]]}function a(e){let[t,r,o,a]=e;return[Math.max(-180,Math.min(180,t)),Math.max(-90,Math.min(90,r)),Math.max(-180,Math.min(180,o)),Math.max(-90,Math.min(90,a))]}r.d(t,{ci:()=>a,w_:()=>o})}};var t=require("../../../../webpack-runtime.js");t.C(e);var r=e=>t(t.s=e),o=t.X(0,[958,792,640],()=>r(21762));module.exports=o})();